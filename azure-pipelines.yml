trigger:
- develop
- master

pool:
  name: Default

steps:
- bash: |
    # Global npm tanpa sudo
    mkdir -p "$(Agent.TempDirectory)/.npm-global"
    echo "##vso[task.setvariable variable=NPM_CONFIG_PREFIX]$(Agent.TempDirectory)/.npm-global"
    echo "##vso[task.setvariable variable=PATH]$(Agent.TempDirectory)/.npm-global/bin:$(PATH)"
  displayName: 'Configure npm global prefix'

- checkout: self
  fetchDepth: 1

- bash: |
    set -e
    mkdir -p .vercel
    if [ "$BUILD_SOURCEBRANCHNAME" = "master" ]; then
      TARGET_PROJECT_ID="$PROD_PROJECT_ID"
      TARGET_ENVIRONMENT="production"
      echo "Target: master -> PROD project"
    else
      TARGET_PROJECT_ID="$STAGING_PROJECT_ID"
      TARGET_ENVIRONMENT="production"
      echo "Target: develop -> STAGING project"
    fi

    cat > .vercel/project.json <<EOF
    {
      "projectId": "$TARGET_PROJECT_ID",
      "orgId": "$ORG_ID"
    }
    EOF

    echo "Created .vercel/project.json:"
    cat .vercel/project.json
  env:
    ORG_ID: $(ORG_ID)
    PROD_PROJECT_ID: $(PROD_PROJECT_ID)
    STAGING_PROJECT_ID: $(STAGING_PROJECT_ID)
    BUILD_SOURCEBRANCHNAME: $(Build.SourceBranchName)
  displayName: 'Generate .vercel/project.json (per branch)'

- bash: |
    set -e
    npm install -g vercel@latest

    vercel pull --yes --environment=production --token "$VERCEL_TOKEN"

    vercel build --prod --token "$VERCEL_TOKEN"
    vercel deploy --prebuilt --prod --token "$VERCEL_TOKEN"
  env:
    NPM_CONFIG_PREFIX: $(NPM_CONFIG_PREFIX)
    PATH: $(PATH)
    VERCEL_TOKEN: $(VERCEL_TOKEN)
  displayName: 'Build & Deploy to Vercel'
